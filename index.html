<!doctype html>
<html>
    <head>
        <title>League Roles ML</title>
        <script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha256-cCueBR6CsyA4/9szpPfrX3s49M9vUU5BgtiJj06wt/s=" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/bacon.js/0.7.84/Bacon.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.34/browser.min.js"></script>
    </head>
    <body>
        <div id="item-list" style="height:64px"></div>
        <button id="submit-button">Submit</button>
        <input id="input" type="text">
        <div id="content"></div>

        <script src=itemsJSON.js></script> <!-- Imports a json called itemsJSON -->
        <script type="text/babel">
        
            function itemSearch(query){
                var itemsNames = Object.keys(itemsJSON)
                return itemsNames.filter(name => 
                    name.toLowerCase().includes(query.toLowerCase())
                ).map(name => [name, itemsJSON[name]])
            }

            function showItems(x){
                var id = x[1];
                var name = x[0];

                var address = "http://ddragon.leagueoflegends.com/cdn/6.14.1/img/item/" + id + ".png";
                return $("<img>", {
                    src: address,
                    //class: "itemImage",
                    title: name
                });
            }

            var text = $("#input")
            .asEventStream("keyup")
            .map(event => event.target.value)
            .skipDuplicates()

            var suggestions = text.flatMapLatest(itemSearch)
            suggestions.onValue(results => {
                $("#content").html($.map(results, showItems))
            })

            $("#input").trigger("keyup"); //Use properties?

            function ItemView(contentsProperty){
                function updateContentView(newContents){
                    $("#item-list").html($.map(newContents, showItems))
                }
                contentsProperty.onValue(updateContentView)
            }

            function spliced(l, index)
            {
                return l.slice(0, index).concat(l.slice(index+1)) 
            }

            function ItemList(initialContents, addItem, removeItem, submitList){
                return Bacon.update(initialContents,
                    addItem, (contents, newItem) => contents.length < 6 ? contents.concat([newItem]) : contents,
                    removeItem, (contents, removedItemIndex) => spliced(contents, removedItemIndex),
                    submitList,  contents => { //side effects are bad :(
                        console.log(contents)
                        return contents
                    }                        
                )
            }

            var submitList = $("#submit-button").asEventStream("click")

            var removeItemStream = $("#item-list").asEventStream("click", "img").map(function(e){
                return $(e.currentTarget).index()
            })
            
            var newItemStream = $("#content").asEventStream("click", "img").map(function(e){
                var name = $(e.currentTarget).attr("title")
                return [name, itemsJSON[name]]
            })

            var itemList = ItemList([], newItemStream, removeItemStream, submitList)
            var itemView = ItemView(itemList)
            
        </script>
    </body>
</html>
